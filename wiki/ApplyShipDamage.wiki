{{{
int __fastcall CMBTFIRE_Apply_Ship_Damage_(__int16 a1, int a2, int a3, int a4, __int16 weaponFlags, int a6, __int16 a7, __int16 bHasAchiles, __int16 a9)
{
  __int16 ptrShip; // di@1
  int nWeaponDamage; // esi@1
  signed int v11; // eax@4
  __int16 bHasHardShields; // kr00_2@10
  int ShipArray; // eax@11
  __int16 v14; // cx@13
  int v15; // eax@28
  int v16; // eax@29
  int v17; // edx@29
  signed int bDamageToInternals; // ecx@39
  int nWeaponActualDamage; // eax@43
  int v20; // eax@48
  int v21; // ebx@48
  int v23; // [sp+18h] [bp-20h]@1
  int DamagingInternal; // [sp+1Ch] [bp-1Ch]@52
  int v25; // [sp+20h] [bp-18h]@1
  int bShieldsActive; // [sp+24h] [bp-14h]@1
  int v27; // [sp+28h] [bp-10h]@43
  int v28; // [sp+2Ch] [bp-Ch]@1
  int v29; // [sp+30h] [bp-8h]@1
  int nHowMuchDamageToInternals; // [sp+34h] [bp-4h]@52

  ptrShip = a1;
  nWeaponDamage = a2;
  v28 = a4;
  v23 = 0;
  v25 = 0;
  v29 = 0;
  LOWORD(bShieldsActive) = 0;
  *(_WORD *)a3 = 0;
  if ( a1 )
  {
    if ( (unsigned __int16)COMBINIT_Does_Combat_Ship_Have_Special_(a1, 10) )
    {
      v11 = (signed int)(*(_WORD *)nWeaponDamage
                       - (__MKCSHL__((unsigned __int64)*(_WORD *)nWeaponDamage >> 32, 2)
                        + 4 * ((unsigned __int64)*(_WORD *)nWeaponDamage >> 32))) >> 2;
      if ( v11 <= 1 )
        LOWORD(v11) = 1;
      *(_WORD *)nWeaponDamage -= v11;
      *(_WORD *)(MOX__combat_data + 313 * ptrShip + 69) += v11;
    }
    if ( (unsigned __int16)COMBINIT_Does_Combat_Ship_Have_Special_(ptrShip, 7) == 1 )
      *(_WORD *)nWeaponDamage = (signed __int16)(*(_WORD *)nWeaponDamage
                                               - (__MKCSHL__((unsigned int)*(_WORD *)nWeaponDamage >> 16, 2)
                                                + 4 * ((unsigned int)*(_WORD *)nWeaponDamage >> 16))) >> 2;
    if ( weaponFlags & 0x40 )
      bHasHardShields = COMBINIT_Does_Combat_Ship_Have_Special_(ptrShip, 13);
    ShipArray = 313 * ptrShip + MOX__combat_data;
    if ( *(_BYTE *)(ShipArray + 38) )
    {
      if ( *(_WORD *)(ShipArray + 308) > 0 )
      {
        if ( (unsigned __int16)COMBINIT_Does_Combat_Ship_Have_Special_(ptrShip, 13) )
        {
          if ( weaponFlags & 0x40 )
            LOBYTE(weaponFlags) = weaponFlags ^ 0x40;
        }
        if ( !(weaponFlags & 0x40) )
        {
          if ( !MOX__in_nebula_flag || (unsigned __int16)COMBINIT_Does_Combat_Ship_Have_Special_(ptrShip, 13) )
          {
            *(_WORD *)nWeaponDamage -= *(__int16 *)((char *)&word_1776C1
                                                  + 59 * *(_BYTE *)(313 * ptrShip + MOX__combat_data + 38));
            if ( (unsigned __int16)COMBINIT_Does_Combat_Ship_Have_Special_(ptrShip, 13) )
              *(_WORD *)nWeaponDamage -= 3;     // ololo
          }
        }
        if ( *(_WORD *)nWeaponDamage < 0 )
          *(_WORD *)nWeaponDamage = 0;
        if ( *(_WORD *)nWeaponDamage > 0 )
        {
          if ( !MOX__in_nebula_flag || (unsigned __int16)COMBINIT_Does_Combat_Ship_Have_Special_(ptrShip, 13) )
            LOWORD(bShieldsActive) = 1;
        }
        if ( v14 <= *(_WORD *)nWeaponDamage )
        {
          v16 = MOX__combat_data;
          *(_WORD *)nWeaponDamage -= v14;
          v17 = (signed __int16)v28;
          *(_WORD *)a3 = v14;
          *(_WORD *)(313 * ptrShip + v16 + 2 * v17 + 41) -= v14;
        }
        else
        {
          v15 = 313 * ptrShip + MOX__combat_data + 2 * (signed __int16)v28;
          *(_WORD *)(v15 + 41) -= *(_WORD *)nWeaponDamage;
          *(_WORD *)a3 = *(_WORD *)nWeaponDamage;
          *(_WORD *)nWeaponDamage = 0;
        }
      }
    }
    if ( a6 & 1 )
      *(_WORD *)nWeaponDamage = 0;
    if ( a6 & 0x10 )
    {
      if ( !(unsigned __int16)COMBINIT_Does_Combat_Ship_Have_Special_(ptrShip, 7) )
      {
        if ( *(_BYTE *)(MOX__combat_data + 313 * ptrShip + 175) < 0xFFu )
          CMBTFIR2_Kill_Crew_(ptrShip, *(_WORD *)nWeaponDamage / 5, ptrShip, 5);
      }
    }
    if ( a7 )
      *(_WORD *)nWeaponDamage *= 2;
    if ( bHasAchiles )
    {
      bDamageToInternals = 1;
    }
    else
    {
      if ( (unsigned __int16)COMBINIT_Does_Combat_Ship_Have_Special_(ptrShip, 14)// heavy armor
        || *(_BYTE *)(MOX__combat_data + 313 * ptrShip + 51) == 6 )
        bDamageToInternals = 0;
    }
    HIWORD(nWeaponActualDamage) = HIWORD(a6);
    LOWORD(nWeaponActualDamage) = a6 & 8;
    v27 = nWeaponActualDamage;
    if ( (_WORD)nWeaponActualDamage )
    {
      nWeaponActualDamage = 313 * ptrShip;
      if ( *(_BYTE *)(MOX__combat_data + nWeaponActualDamage + 32) > 9u )
        *(_WORD *)nWeaponDamage = (signed __int16)(*(_WORD *)nWeaponDamage
                                                 - (__MKCSHL__((unsigned int)*(_WORD *)nWeaponDamage >> 16, 2)
                                                  + 4 * ((unsigned int)*(_WORD *)nWeaponDamage >> 16))) >> 2;
    }
    if ( *(_WORD *)nWeaponDamage > 0 )
    {
      LOBYTE(bShieldsActive) = bShieldsActive | 2;
      if ( a6 & 0x20 )
      {
        v21 = 313 * ptrShip + MOX__combat_data;
        *(_WORD *)(v21 + 192) += *(_WORD *)nWeaponDamage / 2;
        LOWORD(v20) = *(_WORD *)(v21 + 170);
        if ( (_WORD)v20 > *(_WORD *)(v21 + 192) )
        {
          v20 = *(_WORD *)nWeaponDamage / 2 + *(_WORD *)(v21 + 192);
          *(_WORD *)(v21 + 192) = v20;
        }
        *(_WORD *)(MOX__combat_data + 313 * ptrShip + 192) = v20;
        nWeaponActualDamage = *(_WORD *)nWeaponDamage / 2;
        v29 = *(_WORD *)nWeaponDamage / 2;
      }
      if ( (_WORD)bDamageToInternals )
      {
        LOWORD(nWeaponActualDamage) = *(_WORD *)nWeaponDamage;
        nHowMuchDamageToInternals = nWeaponActualDamage;
        for ( DamagingInternal = nWeaponActualDamage;
              (_WORD)DamagingInternal > 0;
              CMBTFIR2_Apply_Internal_Damage_(ptrShip, (int)&DamagingInternal, v23, (signed __int16)v25, 1) )
        {
          nWeaponActualDamage = CMBTFIRE_Is_Combat_Ship_Dead_(ptrShip);
          if ( (_WORD)nWeaponActualDamage )
            break;
          CMBTFIR2_Select_Internal_(ptrShip, (int)&v23, (int)&v25, bHasAchiles, v27, 1, a9);
          if ( (signed __int16)v23 == -1 )
            DamagingInternal = 0;
        }
      }
      else
      {
        nHowMuchDamageToInternals = bDamageToInternals;
      }
      LOWORD(nWeaponActualDamage) = *(_WORD *)nWeaponDamage;
      for ( DamagingInternal = nWeaponActualDamage - nHowMuchDamageToInternals;
            (_WORD)DamagingInternal > 0 && !(unsigned __int16)CMBTFIRE_Is_Combat_Ship_Dead_(ptrShip);
            CMBTFIR2_Apply_Internal_Damage_(ptrShip, (int)&DamagingInternal, v23, (signed __int16)v25, 1) )
      {
        CMBTFIR2_Select_Internal_(ptrShip, (int)&v23, (int)&v25, bHasAchiles, v27, 0, a9);
        if ( (signed __int16)v23 == -1 )
          DamagingInternal = 0;
      }
    }
  }
  else
  {
    LOWORD(bShieldsActive) = CMBTFIRE_Apply_Damage_To_Planet_(a2, weaponFlags, (signed __int16)a6);
  }
  *(_WORD *)nWeaponDamage += v29;
  return bShieldsActive;
}

}}}